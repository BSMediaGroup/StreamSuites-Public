<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feature Requests Login | StreamSuites</title>
  <meta name="robots" content="noindex" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="/css/theme-dark.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/public-pages.css" />
  <link rel="stylesheet" href="/css/public-pages-v2.css" />
  <link rel="stylesheet" href="/css/requests-auth.css" />
</head>
<body class="ss-requests-auth">
  <div class="public-bg" aria-hidden="true"></div>
  <div class="ss-requests-auth__surface">
    <main class="ss-requests-auth__main">
      <section class="ss-panel glass-card ss-requests-auth__panel">
        <header class="ss-requests-auth__header">
          <h1 class="ss-requests-auth__title">
            <img class="ss-requests-auth__logo" src="/assets/logos/pubcon.webp" alt="StreamSuites logo" />
            <span>Log in to StreamSuitesâ„¢</span>
          </h1>
          <p class="ss-requests-auth__subtitle">Sign in to submit feature requests.</p>
        </header>
        <div class="ss-requests-auth__body">
          <p id="requests-login-status" class="ss-requests-auth__status">Checking your session...</p>
          <div id="requests-login-options" hidden>
            <p class="ss-requests-auth__section-kicker">Sign in with</p>
            <div class="ss-requests-auth__oauth-grid">
              <a class="ss-btn ss-btn-primary ss-requests-auth__oauth-button" data-provider="google" href="#">
                <img class="ss-requests-auth__oauth-icon" src="/assets/icons/google.svg" alt="" aria-hidden="true" />
                <span>Google</span>
              </a>
              <a class="ss-btn ss-btn-primary ss-requests-auth__oauth-button" data-provider="github" href="#">
                <img class="ss-requests-auth__oauth-icon" src="/assets/icons/github.svg" alt="" aria-hidden="true" />
                <span>GitHub</span>
              </a>
              <a class="ss-btn ss-btn-primary ss-requests-auth__oauth-button" data-provider="discord" href="#">
                <img class="ss-requests-auth__oauth-icon" src="/assets/icons/discord.svg" alt="" aria-hidden="true" />
                <span>Discord</span>
              </a>
              <a class="ss-btn ss-btn-primary ss-requests-auth__oauth-button" data-provider="x" href="#">
                <img class="ss-requests-auth__oauth-icon" src="/assets/icons/x.svg" alt="" aria-hidden="true" />
                <span>X</span>
              </a>
            </div>
          </div>
          <div class="ss-requests-auth__divider"><span>Feature requests</span></div>
          <div class="ss-requests-auth__actions">
            <a id="requests-login-back" class="ss-btn ss-btn-secondary" href="/requests.html">Back to Feature Requests</a>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const API_BASE = "https://api.streamsuites.app";
      const ME_API_URL = `${API_BASE}/api/me`;
      const DEFAULT_RETURN_TO = "https://streamsuites.app/requests.html";
      const REQUESTS_COMPLETE_URL = "https://streamsuites.app/requests-auth-complete.html";
      const RETURN_STORAGE_KEY = "ss_requests_auth_return_to";
      const ALLOWED_RETURN_ORIGINS = new Set([
        window.location.origin,
        "https://streamsuites.app"
      ]);

      const statusEl = document.getElementById("requests-login-status");
      const optionsEl = document.getElementById("requests-login-options");
      const backLinkEl = document.getElementById("requests-login-back");

      const safeStorageSet = (key, value) => {
        try {
          window.localStorage.setItem(key, value);
        } catch (error) {
          // Ignore localStorage failures in restricted contexts.
        }
      };

      const normalizeReturnTo = (value) => {
        if (!value || typeof value !== "string") return DEFAULT_RETURN_TO;
        const trimmed = value.trim();
        if (!trimmed) return DEFAULT_RETURN_TO;
        try {
          const parsed = new URL(trimmed, window.location.origin);
          if (!ALLOWED_RETURN_ORIGINS.has(parsed.origin)) return DEFAULT_RETURN_TO;
          return parsed.href;
        } catch (error) {
          return DEFAULT_RETURN_TO;
        }
      };

      const readAuthenticated = (payload) => {
        const candidates = [
          payload?.authenticated,
          payload?.is_authenticated,
          payload?.isAuthenticated,
          payload?.data?.authenticated,
          payload?.data?.is_authenticated,
          payload?.data?.isAuthenticated
        ];
        return candidates.some((value) => value === true);
      };

      const params = new URLSearchParams(window.location.search || "");
      const returnTo = normalizeReturnTo(params.get("return_to") || DEFAULT_RETURN_TO);
      safeStorageSet(RETURN_STORAGE_KEY, returnTo);

      if (backLinkEl) {
        backLinkEl.href = returnTo;
      }

      const completeUrl = new URL(REQUESTS_COMPLETE_URL);
      completeUrl.searchParams.set("return_to", returnTo);

      const providerEndpointPaths = {
        google: "/auth/login/google",
        github: "/auth/login/github",
        x: "/auth/x/start",
        discord: "/auth/login/discord"
      };

      Object.keys(providerEndpointPaths).forEach((provider) => {
        const link = document.querySelector(`[data-provider="${provider}"]`);
        if (!(link instanceof HTMLAnchorElement)) return;

        const endpoint = new URL(providerEndpointPaths[provider], API_BASE);
        endpoint.searchParams.set("surface", "creator");
        endpoint.searchParams.set("return_to", completeUrl.toString());
        link.href = endpoint.toString();
      });

      const showOptions = () => {
        if (statusEl) {
          statusEl.textContent = "Choose a login method to continue.";
        }
        if (optionsEl) {
          optionsEl.hidden = false;
        }
      };

      const continueToAuthComplete = () => {
        if (statusEl) {
          statusEl.textContent = "Signed in. Finishing up...";
        }
        window.location.replace(completeUrl.toString());
      };

      fetch(ME_API_URL, {
        method: "GET",
        cache: "no-store",
        credentials: "include",
        headers: { Accept: "application/json" }
      })
        .then((response) => (response.ok ? response.json() : null))
        .then((payload) => {
          if (readAuthenticated(payload)) {
            continueToAuthComplete();
            return;
          }
          showOptions();
        })
        .catch(() => {
          showOptions();
        });
    })();
  </script>
</body>
</html>
