<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign-In Complete | StreamSuites</title>
  <meta name="robots" content="noindex" />
  <style>
    :root {
      color-scheme: dark;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      background: radial-gradient(120% 120% at 50% 0%, #1b263f 0%, #0b1222 58%, #070b14 100%);
      color: #f3f7ff;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    }

    main {
      width: min(94vw, 560px);
      padding: 28px 24px;
      border-radius: 14px;
      border: 1px solid rgba(145, 165, 204, 0.25);
      background: rgba(11, 18, 34, 0.78);
      box-shadow: 0 22px 62px rgba(0, 0, 0, 0.45);
      text-align: center;
    }

    h1 {
      margin: 0 0 10px;
      font-size: 1.45rem;
      line-height: 1.3;
      letter-spacing: 0.01em;
    }

    p {
      margin: 0;
      color: rgba(226, 235, 255, 0.88);
    }

    .actions {
      margin-top: 18px;
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-link {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      min-height: 40px;
      padding: 0 14px;
      border-radius: 10px;
      border: 1px solid rgba(151, 175, 226, 0.45);
      background: linear-gradient(180deg, rgba(35, 51, 84, 0.95), rgba(21, 31, 53, 0.95));
      color: #f3f7ff;
      text-decoration: none;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .btn-link:hover,
    .btn-link:focus-visible {
      border-color: rgba(177, 201, 255, 0.85);
      outline: none;
    }
  </style>
</head>
<body>
  <main>
    <h1>Finishing sign-in...</h1>
    <p id="requests-auth-complete-status">Checking your session...</p>

    <div id="requests-auth-complete-signed-in-actions" class="actions" hidden>
      <a id="requests-auth-complete-back-link" class="btn-link" href="/requests.html">Back to Feature Requests</a>
    </div>

    <div id="requests-auth-complete-login-actions" class="actions" hidden>
      <a id="requests-auth-complete-continue-login" class="btn-link" href="/requests-login.html">Continue to Login</a>
    </div>
  </main>

  <script>
    (function () {
      const ME_API_URL = "https://api.streamsuites.app/api/me";
      const DEFAULT_RETURN_TO = "https://streamsuites.app/requests.html";
      const REQUESTS_LOGIN_URL = "https://streamsuites.app/requests-login.html";
      const RETURN_STORAGE_KEY = "ss_requests_auth_return_to";
      const AUTH_COMPLETE_MESSAGE_TYPE = "ss_requests_auth_complete";
      const AUTH_COMPLETE_MESSAGE_TARGET = "https://streamsuites.app";
      const CLOSE_FALLBACK_DELAY_MS = 600;
      const ALLOWED_RETURN_ORIGINS = new Set([
        window.location.origin,
        "https://streamsuites.app"
      ]);

      const statusEl = document.getElementById("requests-auth-complete-status");
      const signedInActionsEl = document.getElementById("requests-auth-complete-signed-in-actions");
      const loginActionsEl = document.getElementById("requests-auth-complete-login-actions");
      const backLinkEl = document.getElementById("requests-auth-complete-back-link");
      const continueLoginEl = document.getElementById("requests-auth-complete-continue-login");

      const safeStorageGet = (key) => {
        try {
          return window.localStorage.getItem(key);
        } catch (error) {
          return null;
        }
      };

      const safeStorageSet = (key, value) => {
        try {
          window.localStorage.setItem(key, value);
        } catch (error) {
          // Ignore localStorage failures in restricted contexts.
        }
      };

      const normalizeReturnTo = (value) => {
        if (!value || typeof value !== "string") return DEFAULT_RETURN_TO;
        const trimmed = value.trim();
        if (!trimmed) return DEFAULT_RETURN_TO;
        try {
          const parsed = new URL(trimmed, window.location.origin);
          if (!ALLOWED_RETURN_ORIGINS.has(parsed.origin)) return DEFAULT_RETURN_TO;
          return parsed.href;
        } catch (error) {
          return DEFAULT_RETURN_TO;
        }
      };

      const readAuthenticated = (payload) => {
        const candidates = [
          payload?.authenticated,
          payload?.is_authenticated,
          payload?.isAuthenticated,
          payload?.data?.authenticated,
          payload?.data?.is_authenticated,
          payload?.data?.isAuthenticated
        ];
        return candidates.some((value) => value === true);
      };

      const params = new URLSearchParams(window.location.search || "");
      const returnTo = normalizeReturnTo(
        params.get("return_to") || safeStorageGet(RETURN_STORAGE_KEY) || DEFAULT_RETURN_TO
      );
      safeStorageSet(RETURN_STORAGE_KEY, returnTo);

      if (backLinkEl) {
        backLinkEl.href = returnTo;
      }

      if (continueLoginEl) {
        const continueUrl = new URL(REQUESTS_LOGIN_URL);
        continueUrl.searchParams.set("return_to", returnTo);
        continueLoginEl.href = continueUrl.toString();
      }

      const notifyOpener = () => {
        if (!window.opener || typeof window.opener.postMessage !== "function") return;
        try {
          window.opener.postMessage(
            { type: AUTH_COMPLETE_MESSAGE_TYPE },
            AUTH_COMPLETE_MESSAGE_TARGET
          );
        } catch (error) {
          // Ignore cross-window postMessage failures.
        }
      };

      const showSignedInFallback = () => {
        if (statusEl) {
          statusEl.textContent = "Signed in. You can close this tab.";
        }
        if (signedInActionsEl) {
          signedInActionsEl.hidden = false;
        }
        if (loginActionsEl) {
          loginActionsEl.hidden = true;
        }
      };

      const showLoginRequired = () => {
        if (statusEl) {
          statusEl.textContent = "You are not signed in yet.";
        }
        if (loginActionsEl) {
          loginActionsEl.hidden = false;
        }
        if (signedInActionsEl) {
          signedInActionsEl.hidden = true;
        }
      };

      const handleAuthenticated = () => {
        notifyOpener();
        try {
          window.close();
        } catch (error) {
          // Ignore close failures.
        }

        window.setTimeout(() => {
          showSignedInFallback();
        }, CLOSE_FALLBACK_DELAY_MS);
      };

      fetch(ME_API_URL, {
        method: "GET",
        cache: "no-store",
        credentials: "include",
        headers: { Accept: "application/json" }
      })
        .then((response) => (response.ok ? response.json() : null))
        .then((payload) => {
          if (readAuthenticated(payload)) {
            handleAuthenticated();
            return;
          }
          showLoginRequired();
        })
        .catch(() => {
          showLoginRequired();
        });
    })();
  </script>
</body>
</html>
