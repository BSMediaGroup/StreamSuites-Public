<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Signing In | StreamSuites</title>
  <meta name="robots" content="noindex" />
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="/css/theme-dark.css" />
  <link rel="stylesheet" href="/css/components.css" />
  <link rel="stylesheet" href="/css/public-pages.css" />
  <link rel="stylesheet" href="/css/public-pages-v2.css" />
  <link rel="stylesheet" href="/css/requests-auth.css" />
</head>
<body class="ss-requests-auth">
  <div class="public-bg" aria-hidden="true"></div>
  <div class="ss-requests-auth__surface">
    <main class="ss-requests-auth__main">
      <section class="ss-panel glass-card ss-requests-auth__panel">
        <header class="ss-requests-auth__header">
          <h1 class="ss-requests-auth__title">
            <img class="ss-requests-auth__logo" src="/assets/logos/pubcon.webp" alt="StreamSuites logo" />
            <span>Signing you in...</span>
          </h1>
          <p class="ss-requests-auth__subtitle">Checking your session and opening login.</p>
        </header>
        <div class="ss-requests-auth__body">
          <p id="auth-bridge-status" class="ss-requests-auth__status">Checking your session and opening login.</p>
          <div class="ss-requests-auth__actions">
            <a id="auth-bridge-open-login" class="ss-btn ss-btn-primary" href="#" target="_blank" hidden>Open login</a>
            <a id="auth-bridge-back" class="ss-btn ss-btn-secondary" href="/requests.html">Back to Feature Requests</a>
          </div>
          <p class="ss-requests-auth__meta">If a popup is blocked, use Open login to continue.</p>
        </div>
      </section>
    </main>
  </div>

  <script>
    (function () {
      const ME_API_URL = "https://api.streamsuites.app/api/me";
      const REQUESTS_LOGIN_URL = "https://streamsuites.app/requests-login.html";
      const DEFAULT_RETURN_TO = "https://streamsuites.app/requests.html";
      const RETURN_STORAGE_KEY = "ss_requests_auth_return_to";
      const POPUP_LAUNCHED_STORAGE_KEY = "ss_requests_popup_launched";
      const POPUP_BLOCKED_STORAGE_KEY = "ss_requests_popup_blocked";
      const POLL_INTERVAL_MS = 800;
      const AUTH_COMPLETE_MESSAGE_TYPE = "ss_requests_auth_complete";
      const ALLOWED_MESSAGE_ORIGINS = new Set([
        window.location.origin,
        "https://streamsuites.app"
      ]);

      const statusEl = document.getElementById("auth-bridge-status");
      const openLoginEl = document.getElementById("auth-bridge-open-login");
      const backLinkEl = document.getElementById("auth-bridge-back");

      let pollTimer = 0;
      let checkInFlight = false;
      let redirecting = false;
      let loginWindow = null;
      let launchedLogin = false;

      const setStatus = (text) => {
        if (statusEl) statusEl.textContent = text;
      };

      const safeStorageSet = (key, value) => {
        try {
          window.localStorage.setItem(key, value);
        } catch (error) {
          // Ignore localStorage failures in restricted contexts.
        }
      };

      const safeSessionStorageGet = (key) => {
        try {
          return window.sessionStorage.getItem(key);
        } catch (error) {
          return null;
        }
      };

      const safeSessionStorageRemove = (key) => {
        try {
          window.sessionStorage.removeItem(key);
        } catch (error) {
          // Ignore sessionStorage failures in restricted contexts.
        }
      };

      const readAuthenticated = (payload) => {
        const candidates = [
          payload?.authenticated,
          payload?.is_authenticated,
          payload?.isAuthenticated,
          payload?.data?.authenticated,
          payload?.data?.is_authenticated,
          payload?.data?.isAuthenticated
        ];
        return candidates.some((value) => value === true);
      };

      const normalizeReturnTo = (value) => {
        if (!value || typeof value !== "string") return DEFAULT_RETURN_TO;
        const trimmed = value.trim();
        if (!trimmed) return DEFAULT_RETURN_TO;
        try {
          const parsed = new URL(trimmed, window.location.origin);
          const isSameOrigin = parsed.origin === window.location.origin;
          const isCanonicalOrigin = parsed.origin === "https://streamsuites.app";
          if (!isSameOrigin && !isCanonicalOrigin) return DEFAULT_RETURN_TO;
          return parsed.href;
        } catch (error) {
          return DEFAULT_RETURN_TO;
        }
      };

      const params = new URLSearchParams(window.location.search || "");
      const fromQuery = params.get("return_to");
      const returnTo = normalizeReturnTo(fromQuery || DEFAULT_RETURN_TO);
      const popupLaunchedFromSubmit = safeSessionStorageGet(POPUP_LAUNCHED_STORAGE_KEY) === "1";
      const popupBlockedFromSubmit = safeSessionStorageGet(POPUP_BLOCKED_STORAGE_KEY) === "1";
      const suppressAutoOpen = popupLaunchedFromSubmit || popupBlockedFromSubmit;
      safeStorageSet(RETURN_STORAGE_KEY, returnTo);

      if (backLinkEl) {
        backLinkEl.href = returnTo;
      }

      const requestsLoginUrl = new URL(REQUESTS_LOGIN_URL);
      requestsLoginUrl.searchParams.set("return_to", returnTo);

      if (openLoginEl) {
        openLoginEl.href = requestsLoginUrl.toString();
      }

      const ensureLoginVisible = () => {
        if (loginWindow && !loginWindow.closed) {
          return;
        }

        if (launchedLogin) {
          if (openLoginEl) openLoginEl.hidden = false;
          setStatus("Complete sign-in in the login window, then return here automatically.");
          return;
        }

        launchedLogin = true;
        setStatus("Opening login...");
        loginWindow = window.open(
          requestsLoginUrl.toString(),
          "ss_public_auth_login",
          "popup=yes,width=560,height=760"
        );
        if (loginWindow) {
          try {
            loginWindow.name = "ss_requests_auth";
          } catch (error) {
            // Ignore cross-origin timing issues when setting window.name.
          }
        }

        if (!loginWindow) {
          if (openLoginEl) openLoginEl.hidden = false;
          setStatus("Login popup blocked. Use Open login to continue sign-in.");
          return;
        }

        setStatus("Complete sign-in in the login window. You will be redirected automatically.");
      };

      const redirectToReturnTarget = () => {
        if (redirecting) return;
        redirecting = true;
        window.clearInterval(pollTimer);
        safeSessionStorageRemove(POPUP_LAUNCHED_STORAGE_KEY);
        safeSessionStorageRemove(POPUP_BLOCKED_STORAGE_KEY);
        try {
          if (loginWindow && !loginWindow.closed) {
            loginWindow.close();
          }
        } catch (error) {
          // Ignore popup close failures.
        }
        window.location.replace(returnTo);
      };

      const checkAuth = async () => {
        if (checkInFlight || redirecting) return;
        checkInFlight = true;
        try {
          const response = await fetch(ME_API_URL, {
            method: "GET",
            cache: "no-store",
            credentials: "include",
            headers: { Accept: "application/json" }
          });

          if (response.ok) {
            const payload = await response.json().catch(() => null);
            if (readAuthenticated(payload)) {
              redirectToReturnTarget();
              return;
            }
          }
        } catch (error) {
          // Treat transient API failures as unauthenticated.
        } finally {
          checkInFlight = false;
        }

        if (popupBlockedFromSubmit) {
          if (openLoginEl) openLoginEl.hidden = false;
          return;
        }

        if (!suppressAutoOpen) {
          ensureLoginVisible();
        }
      };

      if (popupBlockedFromSubmit) {
        if (openLoginEl) openLoginEl.hidden = false;
        setStatus("Login popup blocked. Use Open login to continue sign-in.");
      } else if (popupLaunchedFromSubmit) {
        setStatus("Complete sign-in in the login window. You will be redirected automatically.");
      } else {
        ensureLoginVisible();
      }

      checkAuth();
      pollTimer = window.setInterval(checkAuth, POLL_INTERVAL_MS);

      window.addEventListener("message", (event) => {
        if (!ALLOWED_MESSAGE_ORIGINS.has(event.origin)) return;
        const isRequestsAuthComplete =
          event.data &&
          typeof event.data === "object" &&
          event.data.type === AUTH_COMPLETE_MESSAGE_TYPE;
        if (!isRequestsAuthComplete) return;

        redirectToReturnTarget();
      });

      window.addEventListener("beforeunload", () => {
        window.clearInterval(pollTimer);
      });
    })();
  </script>
</body>
</html>
